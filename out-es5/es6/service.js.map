{"version":3,"sources":["../../out/es6/service.js"],"names":["__awaiter","thisArg","_arguments","P","generator","Promise","resolve","reject","fulfilled","value","step","next","e","rejected","result","done","then","apply","Object","defineProperty","exports","callback_1","require","errors_1","Service","error","Callbacks","url","options","undefined","data","method","headers","body","is_json","indexOf","JSON","stringify","URLSearchParams","key","append","reslove","timeId","errors","unexpectedNullValue","setTimeout","err","Error","name","message","fire","clearTimeout","settings","ajaxTimeout","ajax","type","service","add","sender","fetch","response","responseText","text","p","isJSONContextType","get","textObject","parse","status","Message","statusText"],"mappings":"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","sourcesContent":["\"use strict\";\r\nvar __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {\r\n    return new (P || (P = Promise))(function (resolve, reject) {\r\n        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }\r\n        function rejected(value) { try { step(generator[\"throw\"](value)); } catch (e) { reject(e); } }\r\n        function step(result) { result.done ? resolve(result.value) : new P(function (resolve) { resolve(result.value); }).then(fulfilled, rejected); }\r\n        step((generator = generator.apply(thisArg, _arguments || [])).next());\r\n    });\r\n};\r\nObject.defineProperty(exports, \"__esModule\", { value: true });\r\nconst callback_1 = require(\"./callback\");\r\nconst errors_1 = require(\"./errors\");\r\nclass Service {\r\n    constructor() {\r\n        this.error = callback_1.Callbacks();\r\n    }\r\n    ajax(url, options) {\r\n        // options = options || {} as any\r\n        if (options === undefined)\r\n            options = {};\r\n        let data = options.data;\r\n        let method = options.method;\r\n        let headers = options.headers || {};\r\n        let body;\r\n        if (data != null) {\r\n            let is_json = (headers['content-type'] || '').indexOf('json') >= 0;\r\n            if (is_json) {\r\n                body = JSON.stringify(data);\r\n            }\r\n            else {\r\n                body = new URLSearchParams();\r\n                for (let key in data) {\r\n                    body.append(key, data[key]);\r\n                }\r\n            }\r\n        }\r\n        // return callAjax<T>(url, { headers: headers as any, body, method }, this, this.error);\r\n        return new Promise((reslove, reject) => {\r\n            let options = { headers: headers, body, method };\r\n            let timeId;\r\n            if (options == null)\r\n                throw errors_1.errors.unexpectedNullValue('options');\r\n            if (method == 'get') {\r\n                timeId = setTimeout(() => {\r\n                    let err = new Error(); //new AjaxError(options.method);\r\n                    err.name = 'timeout';\r\n                    err.message = '网络连接超时';\r\n                    reject(err);\r\n                    this.error.fire(this, err);\r\n                    clearTimeout(timeId);\r\n                }, Service.settings.ajaxTimeout * 1000);\r\n            }\r\n            ajax(url, options)\r\n                .then(data => {\r\n                reslove(data);\r\n                if (timeId)\r\n                    clearTimeout(timeId);\r\n            })\r\n                .catch(err => {\r\n                reject(err);\r\n                this.error.fire(this, err);\r\n                if (timeId)\r\n                    clearTimeout(timeId);\r\n            });\r\n        });\r\n    }\r\n    /**\r\n     * 创建服务\r\n     * @param type 服务类型\r\n     */\r\n    createService(type) {\r\n        type = type || Service;\r\n        let service = new type();\r\n        service.error.add((sender, error) => {\r\n            this.error.fire(service, error);\r\n        });\r\n        return service;\r\n    }\r\n}\r\nService.settings = {\r\n    ajaxTimeout: 30,\r\n};\r\nexports.Service = Service;\r\nfunction ajax(url, options) {\r\n    return __awaiter(this, void 0, void 0, function* () {\r\n        let response = yield fetch(url, options);\r\n        let responseText = response.text();\r\n        let p;\r\n        if (typeof responseText == 'string') {\r\n            p = new Promise((reslove, reject) => {\r\n                reslove(responseText);\r\n            });\r\n        }\r\n        else {\r\n            p = responseText;\r\n        }\r\n        let text = yield responseText;\r\n        let textObject;\r\n        let isJSONContextType = (response.headers.get('content-type') || '').indexOf('json') >= 0;\r\n        if (isJSONContextType) {\r\n            textObject = text ? JSON.parse(text) : null;\r\n        }\r\n        else {\r\n            textObject = text;\r\n        }\r\n        if (response.status >= 300) {\r\n            let err = new Error();\r\n            err.method = options.method;\r\n            err.name = `${response.status}`;\r\n            err.message = isJSONContextType ? (textObject.Message || textObject.message) : textObject;\r\n            err.message = err.message || response.statusText;\r\n            throw err;\r\n        }\r\n        return textObject;\r\n    });\r\n}\r\n"],"file":"service.js"}