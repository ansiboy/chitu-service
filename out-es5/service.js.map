{"version":3,"sources":["../out/service.js"],"names":["__awaiter","thisArg","_arguments","P","generator","Promise","resolve","reject","fulfilled","value","step","next","e","rejected","result","done","then","apply","define","require","exports","callback_1","errors_1","Object","defineProperty","Service","error","Callbacks","url","options","undefined","data","method","headers","body","is_json","indexOf","JSON","stringify","URLSearchParams","key","append","reslove","timeId","errors","unexpectedNullValue","setTimeout","err","Error","name","message","fire","clearTimeout","settings","ajaxTimeout","ajax","catch","type","service","isClass","add","sender","toString","Function","prototype","fnBody","fn","call","replace","test","fetch","response","responseText","text","p","isJSONContextType","get","textObject","parse","status","Message","statusText"],"mappings":"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","sourcesContent":["var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {\r\n    return new (P || (P = Promise))(function (resolve, reject) {\r\n        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }\r\n        function rejected(value) { try { step(generator[\"throw\"](value)); } catch (e) { reject(e); } }\r\n        function step(result) { result.done ? resolve(result.value) : new P(function (resolve) { resolve(result.value); }).then(fulfilled, rejected); }\r\n        step((generator = generator.apply(thisArg, _arguments || [])).next());\r\n    });\r\n};\r\ndefine([\"require\", \"exports\", \"./callback\", \"./errors\"], function (require, exports, callback_1, errors_1) {\r\n    \"use strict\";\r\n    Object.defineProperty(exports, \"__esModule\", { value: true });\r\n    class Service {\r\n        constructor() {\r\n            this.error = callback_1.Callbacks();\r\n        }\r\n        ajax(url, options) {\r\n            // options = options || {} as any\r\n            if (options === undefined)\r\n                options = {};\r\n            let data = options.data;\r\n            let method = options.method;\r\n            let headers = options.headers || {};\r\n            let body;\r\n            if (data != null) {\r\n                let is_json = (headers['content-type'] || '').indexOf('json') >= 0;\r\n                if (is_json) {\r\n                    body = JSON.stringify(data);\r\n                }\r\n                else {\r\n                    body = new URLSearchParams();\r\n                    for (let key in data) {\r\n                        body.append(key, data[key]);\r\n                    }\r\n                }\r\n            }\r\n            // return callAjax<T>(url, { headers: headers as any, body, method }, this, this.error);\r\n            return new Promise((reslove, reject) => {\r\n                let options = { headers: headers, body, method };\r\n                let timeId;\r\n                if (options == null)\r\n                    throw errors_1.errors.unexpectedNullValue('options');\r\n                if (method == 'get') {\r\n                    timeId = setTimeout(() => {\r\n                        let err = new Error(); //new AjaxError(options.method);\r\n                        err.name = 'timeout';\r\n                        err.message = '网络连接超时';\r\n                        reject(err);\r\n                        this.error.fire(this, err);\r\n                        clearTimeout(timeId);\r\n                    }, Service.settings.ajaxTimeout * 1000);\r\n                }\r\n                ajax(url, options)\r\n                    .then(data => {\r\n                    reslove(data);\r\n                    if (timeId)\r\n                        clearTimeout(timeId);\r\n                })\r\n                    .catch(err => {\r\n                    reject(err);\r\n                    this.error.fire(this, err);\r\n                    if (timeId)\r\n                        clearTimeout(timeId);\r\n                });\r\n            });\r\n        }\r\n        /**\r\n         * 创建服务\r\n         * @param type 服务类型\r\n         */\r\n        createService(type) {\r\n            type = type || Service;\r\n            let service = Service.isClass(type) ? new type() : type();\r\n            service.error.add((sender, error) => {\r\n                this.error.fire(service, error);\r\n            });\r\n            return service;\r\n        }\r\n    }\r\n    Service.settings = {\r\n        ajaxTimeout: 30,\r\n    };\r\n    Service.isClass = (function () {\r\n        var toString = Function.prototype.toString;\r\n        function fnBody(fn) {\r\n            return toString.call(fn).replace(/^[^{]*{\\s*/, '').replace(/\\s*}[^}]*$/, '');\r\n        }\r\n        function isClass(fn) {\r\n            return (typeof fn === 'function' &&\r\n                (/^class(\\s|\\{\\}$)/.test(toString.call(fn)) ||\r\n                    (/^.*classCallCheck\\(/.test(fnBody(fn)))) // babel.js\r\n            );\r\n        }\r\n        return isClass;\r\n    })();\r\n    exports.Service = Service;\r\n    function ajax(url, options) {\r\n        return __awaiter(this, void 0, void 0, function* () {\r\n            let response = yield fetch(url, options);\r\n            let responseText = response.text();\r\n            let p;\r\n            if (typeof responseText == 'string') {\r\n                p = new Promise((reslove, reject) => {\r\n                    reslove(responseText);\r\n                });\r\n            }\r\n            else {\r\n                p = responseText;\r\n            }\r\n            let text = yield responseText;\r\n            let textObject;\r\n            let isJSONContextType = (response.headers.get('content-type') || '').indexOf('json') >= 0;\r\n            if (isJSONContextType) {\r\n                textObject = text ? JSON.parse(text) : null;\r\n            }\r\n            else {\r\n                textObject = text;\r\n            }\r\n            if (response.status >= 300) {\r\n                let err = new Error();\r\n                err.method = options.method;\r\n                err.name = `${response.status}`;\r\n                err.message = isJSONContextType ? (textObject.Message || textObject.message) : textObject;\r\n                err.message = err.message || response.statusText;\r\n                throw err;\r\n            }\r\n            return textObject;\r\n        });\r\n    }\r\n});\r\n"],"file":"service.js"}