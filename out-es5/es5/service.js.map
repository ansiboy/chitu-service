{"version":3,"sources":["../es6/service.js"],"names":["__awaiter","P","step","generator","reject","result","resolve","_arguments","Object","value","callback_1","require","errors_1","Service","url","options","data","method","headers","is_json","body","JSON","timeId","setTimeout","err","clearTimeout","ajax","reslove","type","service","ajaxTimeout","exports","response","fetch","responseText","p","text","isJSONContextType","textObject"],"mappings":"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","sourcesContent":["\"use strict\";\r\nvar __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {\r\n    return new (P || (P = Promise))(function (resolve, reject) {\r\n        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }\r\n        function rejected(value) { try { step(generator[\"throw\"](value)); } catch (e) { reject(e); } }\r\n        function step(result) { result.done ? resolve(result.value) : new P(function (resolve) { resolve(result.value); }).then(fulfilled, rejected); }\r\n        step((generator = generator.apply(thisArg, _arguments || [])).next());\r\n    });\r\n};\r\nObject.defineProperty(exports, \"__esModule\", { value: true });\r\nconst callback_1 = require(\"./callback\");\r\nconst errors_1 = require(\"./errors\");\r\nclass Service {\r\n    constructor() {\r\n        this.error = callback_1.Callbacks();\r\n    }\r\n    ajax(url, options) {\r\n        // options = options || {} as any\r\n        if (options === undefined)\r\n            options = {};\r\n        let data = options.data;\r\n        let method = options.method;\r\n        let headers = options.headers || {};\r\n        let body;\r\n        if (data != null) {\r\n            let is_json = (headers['content-type'] || '').indexOf('json') >= 0;\r\n            if (is_json) {\r\n                body = JSON.stringify(data);\r\n            }\r\n            else {\r\n                body = new URLSearchParams();\r\n                for (let key in data) {\r\n                    body.append(key, data[key]);\r\n                }\r\n            }\r\n        }\r\n        // return callAjax<T>(url, { headers: headers as any, body, method }, this, this.error);\r\n        return new Promise((reslove, reject) => {\r\n            let options = { headers: headers, body, method };\r\n            let timeId;\r\n            if (options == null)\r\n                throw errors_1.errors.unexpectedNullValue('options');\r\n            if (method == 'get') {\r\n                timeId = setTimeout(() => {\r\n                    let err = new Error(); //new AjaxError(options.method);\r\n                    err.name = 'timeout';\r\n                    err.message = '网络连接超时';\r\n                    reject(err);\r\n                    this.error.fire(this, err);\r\n                    clearTimeout(timeId);\r\n                }, Service.settings.ajaxTimeout * 1000);\r\n            }\r\n            ajax(url, options)\r\n                .then(data => {\r\n                reslove(data);\r\n                if (timeId)\r\n                    clearTimeout(timeId);\r\n            })\r\n                .catch(err => {\r\n                reject(err);\r\n                this.error.fire(this, err);\r\n                if (timeId)\r\n                    clearTimeout(timeId);\r\n            });\r\n        });\r\n    }\r\n    /**\r\n     * 创建服务\r\n     * @param type 服务类型\r\n     */\r\n    createService(type) {\r\n        type = type || Service;\r\n        let service = new type();\r\n        service.error.add((sender, error) => {\r\n            this.error.fire(service, error);\r\n        });\r\n        return service;\r\n    }\r\n}\r\nService.settings = {\r\n    ajaxTimeout: 30,\r\n};\r\nexports.Service = Service;\r\nfunction ajax(url, options) {\r\n    return __awaiter(this, void 0, void 0, function* () {\r\n        let response = yield fetch(url, options);\r\n        let responseText = response.text();\r\n        let p;\r\n        if (typeof responseText == 'string') {\r\n            p = new Promise((reslove, reject) => {\r\n                reslove(responseText);\r\n            });\r\n        }\r\n        else {\r\n            p = responseText;\r\n        }\r\n        let text = yield responseText;\r\n        let textObject;\r\n        let isJSONContextType = (response.headers.get('content-type') || '').indexOf('json') >= 0;\r\n        if (isJSONContextType) {\r\n            textObject = text ? JSON.parse(text) : null;\r\n        }\r\n        else {\r\n            textObject = text;\r\n        }\r\n        if (response.status >= 300) {\r\n            let err = new Error();\r\n            err.method = options.method;\r\n            err.name = `${response.status}`;\r\n            err.message = isJSONContextType ? (textObject.Message || textObject.message) : textObject;\r\n            err.message = err.message || response.statusText;\r\n            throw err;\r\n        }\r\n        return textObject;\r\n    });\r\n}\r\n"],"file":"service.js"}